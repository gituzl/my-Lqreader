<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI 沉浸式阅读 (LingQ Pro)</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; background-color: #f9fafb; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 单词交互样式 */
        .word-span { 
            cursor: pointer; 
            border-radius: 4px; 
            padding: 1px 2px; 
            margin: 0 1px;
            transition: all 0.15s ease; 
            display: inline-block; 
            line-height: 1.8;
        }
        .word-span:hover { background-color: #e5e7eb; }
        .word-span.active { 
            background-color: #fde047; /* 亮黄色高亮 */
            color: #000; 
            font-weight: 600; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            transform: scale(1.05);
        }

        /* 底部弹窗动画 */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        /* 隐藏滚动条 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* iOS 安全区域适配 */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-gray-800">
    
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 ---
        const Icon = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ overflow: 'visible' }}>{children}</svg>
        );
        const BookOpen = (p) => <Icon {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Icon>;
        const SettingsIcon = (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const Play = (p) => <Icon {...p}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const X = (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const Upload = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>;
        const Trash2 = (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.9 5.8a2 2 0 0 1-1.2 1.3L3 12l5.9 1.9a2 2 0 0 1 1.2 1.3L12 21l1.9-5.8a2 2 0 0 1 1.2-1.3L12 3z"/></Icon>;
        const ChevronDown = (p) => <Icon {...p}><polyline points="6 9 12 15 18 9"/></Icon>;
        const Check = (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>;
        const AlertCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const Loader = (p) => <Icon {...p} className={`${p.className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>;
        const RotateCcw = (p) => <Icon {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></Icon>;

        // --- 预设配置 ---
        const TRANS_PRESETS = [
            { id: 'siliconflow', name: 'SiliconFlow (推荐)', url: 'https://api.siliconflow.cn/v1', model: 'Qwen/Qwen2.5-7B-Instruct' },
            { id: 'deepseek', name: 'DeepSeek (深度求索)', url: 'https://api.deepseek.com', model: 'deepseek-chat' },
            { id: 'openai', name: 'OpenAI (官方)', url: 'https://api.openai.com/v1', model: 'gpt-4o-mini' },
            { id: 'gemini', name: 'Google Gemini', url: 'https://generativelanguage.googleapis.com/v1beta/openai/', model: 'gemini-1.5-flash' },
            { id: 'custom', name: '自定义接口...', url: '', model: '' }
        ];

        const TTS_PRESETS = [
            { id: 'browser', name: '浏览器/有道 (免费/极速)', url: '', type: 'browser' },
            { id: 'openai_tts', name: 'OpenAI TTS (拟真/付费)', url: 'https://api.openai.com/v1', type: 'openai' },
            { id: 'azure_tts', name: 'Azure TTS (微软/多语种)', url: 'https://eastus.tts.speech.microsoft.com/cognitiveservices/v1', type: 'azure' },
            { id: 'custom_tts', name: '自定义 TTS...', url: '', type: 'openai' }
        ];

        // Azure 默认语音映射
        const AZURE_VOICE_MAP = {
            'en': 'en-US-AvaMultilingualNeural',
            'fr': 'fr-FR-DeniseNeural',
            'ru': 'ru-RU-SvetlanaNeural',
            'de': 'de-DE-KatjaNeural',
            'es': 'es-ES-ElviraNeural',
            'ja': 'ja-JP-NanamiNeural'
        };

        const LANG_CONFIG = {
            'en': { name: 'English', code: 'en-US', label: '英语', dictCode: 'eng' },
            'fr': { name: 'French', code: 'fr-FR', label: '法语', dictCode: 'fr' },
            'ru': { name: 'Russian', code: 'ru-RU', label: '俄语', dictCode: 'ru' },
            'de': { name: 'German', code: 'de-DE', label: '德语', dictCode: 'de' },
            'es': { name: 'Spanish', code: 'es-ES', label: '西语', dictCode: 'es' },
            'ja': { name: 'Japanese', code: 'ja-JP', label: '日语', dictCode: 'jap' }
        };

        const DEFAULT_CONFIG = {
            transProvider: 'siliconflow',
            transUrl: 'https://api.siliconflow.cn/v1',
            transKey: '',
            transModel: 'Qwen/Qwen2.5-7B-Instruct',
            ttsProvider: 'browser', 
            ttsUrl: 'https://api.openai.com/v1',
            ttsKey: '',
            ttsModel: 'tts-1',
            ttsVoice: '', 
        };

        const App = () => {
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [parsedWords, setParsedWords] = useState([]);
            const [currentLang, setCurrentLang] = useState('en');
            const [fileName, setFileName] = useState("");
            
            const [showSettings, setShowSettings] = useState(false);
            const [showGenerateModal, setShowGenerateModal] = useState(false);
            
            const [selectedWord, setSelectedWord] = useState(null); 
            const [translation, setTranslation] = useState("");
            const [isTranslating, setIsTranslating] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [contextSentence, setContextSentence] = useState("");

            const [transTestStatus, setTransTestStatus] = useState('idle');
            const [transTestMsg, setTransTestMsg] = useState('');
            const [ttsTestStatus, setTtsTestStatus] = useState('idle');
            const [ttsTestMsg, setTtsTestMsg] = useState('');
            
            const fileInputRef = useRef(null);
            const audioRef = useRef(new Audio()); 

            useEffect(() => {
                const saved = localStorage.getItem('lingq_pro_config_v4');
                if (saved) {
                    try { setConfig({ ...DEFAULT_CONFIG, ...JSON.parse(saved) }); } catch (e) {}
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('lingq_pro_config_v4', JSON.stringify(config));
            }, [config]);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (e.target.classList.contains('word-span')) return;
                    const panel = document.getElementById('bottom-panel');
                    if (panel && !panel.contains(e.target)) {
                        setSelectedWord(null);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                document.addEventListener('touchstart', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                    document.removeEventListener('touchstart', handleClickOutside);
                };
            }, []);

            const parseText = (rawText, name = "Imported Text") => {
                const tokens = rawText.split(/([ \t\n\r,.?!;:"'()\[\]\—\-]+)/).filter(t => t);
                setParsedWords(tokens);
                setFileName(name);
                setSelectedWord(null); 
            };

            const speakWord = async (word, overrideLang = null) => {
                const targetLang = overrideLang || currentLang;

                if (config.ttsProvider === 'browser') {
                    const dictCode = LANG_CONFIG[targetLang].dictCode;
                    let url = '';
                    if (targetLang === 'en') {
                        url = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word)}&type=2`;
                    } else {
                        url = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word)}&le=${dictCode}`;
                    }
                    const audio = audioRef.current;
                    audio.src = url;
                    audio.volume = 1.0;
                    audio.play().catch(() => {
                        if (window.speechSynthesis) {
                            window.speechSynthesis.cancel();
                            const utterance = new SpeechSynthesisUtterance(word);
                            utterance.lang = LANG_CONFIG[targetLang].code;
                            window.speechSynthesis.speak(utterance);
                        }
                    });
                    return;
                }

                if (config.ttsProvider === 'azure_tts') {
                    if (!config.ttsKey) return alert("请先配置 Azure API Key");
                    
                    const defaultVoice = AZURE_VOICE_MAP[targetLang] || 'en-US-AvaMultilingualNeural';
                    const voiceName = config.ttsVoice || defaultVoice;
                    
                    const ssml = `<speak version='1.0' xml:lang='${LANG_CONFIG[targetLang].code}'><voice xml:lang='${LANG_CONFIG[targetLang].code}' name='${voiceName}'>${word}</voice></speak>`;
                    
                    try {
                        const response = await fetch(config.ttsUrl, {
                            method: 'POST',
                            headers: {
                                'Ocp-Apim-Subscription-Key': config.ttsKey,
                                'Content-Type': 'application/ssml+xml',
                                'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3',
                                'User-Agent': 'LingQPro'
                            },
                            body: ssml
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`Azure Error (${response.status}): ${errText.substring(0, 100)}`);
                        }
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        new Audio(url).play();
                    } catch (e) {
                        alert("播放失败: " + e.message + "\n请检查 Region 和 Key");
                    }
                    return;
                }

                if (config.ttsProvider === 'openai_tts' || config.ttsProvider === 'custom_tts') {
                    if (!config.ttsKey) return alert("请先配置 TTS API Key");
                    try {
                        const response = await fetch(`${config.ttsUrl}/audio/speech`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.ttsKey}` },
                            body: JSON.stringify({ model: config.ttsModel, input: word, voice: config.ttsVoice || 'alloy' })
                        });
                        if (!response.ok) throw new Error("API Error");
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        new Audio(url).play();
                    } catch (e) {
                        alert("播放失败: " + e.message);
                    }
                }
            };

            const generateArticle = async (level) => {
                if (!config.transKey) {
                    alert(`请先配置 API Key`);
                    setShowGenerateModal(false);
                    setShowSettings(true);
                    return;
                }
                if (parsedWords.length > 0 && !window.confirm("新文章将覆盖当前内容，继续吗？")) return;
                
                setIsGenerating(true);
                setShowGenerateModal(false);

                try {
                    const targetLangName = LANG_CONFIG[currentLang].name;
                    const prompt = `Write a short article (200 words) in ${targetLangName} for CEFR ${level}. Topic: Daily life. Plain text only.`;
                    
                    const apiUrl = config.transUrl.endsWith('/chat/completions') ? config.transUrl : `${config.transUrl}/chat/completions`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.transKey}` },
                        body: JSON.stringify({
                            model: config.transModel,
                            messages: [{ role: "user", content: prompt }],
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    const generatedText = data.choices?.[0]?.message?.content || "";
                    parseText(generatedText, `AI Generated (${level})`);
                } catch (error) {
                    alert("生成失败: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            // --- 单词翻译 ---
            const translateWord = async (word, context) => {
                setIsTranslating(true);
                setTranslation("");
                
                if (!config.transKey) {
                    setTranslation("未配置 API Key，无法翻译");
                    setIsTranslating(false);
                    return;
                }

                try {
                    // Optimized Prompt: Stronger instruction to translate ONLY the word, but use context for disambiguation.
                    // Reduced max_tokens and temperature for speed.
                    const prompt = `Translate the word "${word}" into Simplified Chinese based on this context: "...${context}...". \n\nRules:\n1. Translate ONLY the word "${word}", NOT the whole sentence.\n2. Output JUST the Chinese meaning (no pinyin, no extra words).`;
                    
                    const apiUrl = config.transUrl.endsWith('/chat/completions') ? config.transUrl : `${config.transUrl}/chat/completions`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.transKey}` },
                        body: JSON.stringify({
                            model: config.transModel,
                            messages: [
                                { role: "system", content: "You are a concise dictionary helper." },
                                { role: "user", content: prompt }
                            ],
                            temperature: 0.1,
                            max_tokens: 30
                        })
                    });

                    const data = await response.json();
                    setTranslation(data.choices?.[0]?.message?.content || "翻译失败");
                } catch (error) {
                    setTranslation("Error: " + error.message);
                } finally {
                    setIsTranslating(false);
                }
            };

            const handleWordClick = (word, index) => {
                if (!/[a-zA-Z0-9\u00C0-\u024F\u0400-\u04FF\u4e00-\u9fa5]/.test(word)) return;
                setSelectedWord({ word, index });
                speakWord(word); 
                const start = Math.max(0, index - 15);
                const end = Math.min(parsedWords.length, index + 15);
                const context = parsedWords.slice(start, end).join("");
                setContextSentence(context);
                translateWord(word, context);
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => parseText(e.target.result, file.name);
                if (file.name.endsWith('.docx')) {
                     file.arrayBuffer().then(buffer => mammoth.extractRawText({ arrayBuffer: buffer }).then(r => parseText(r.value, file.name)));
                } else {
                    reader.readAsText(file);
                }
                e.target.value = '';
            };

            const testTransConnection = async () => {
                if(!config.transKey) return setTransTestMsg("请先输入 API Key");
                setTransTestStatus('loading');
                setTransTestMsg('');
                try {
                    const apiUrl = config.transUrl.endsWith('/chat/completions') ? config.transUrl : `${config.transUrl}/chat/completions`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.transKey}` },
                        body: JSON.stringify({
                            model: config.transModel,
                            messages: [{ role: "user", content: "Hi" }],
                            max_tokens: 5
                        })
                    });
                    if (response.ok) {
                        setTransTestStatus('success');
                        setTransTestMsg('连接成功！');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (e) {
                    setTransTestStatus('error');
                    setTransTestMsg('连接失败: ' + e.message);
                }
            };

            const testTTSConnection = async () => {
                if(config.ttsProvider !== 'browser' && !config.ttsKey) return setTtsTestMsg("请先输入 API Key");
                setTtsTestStatus('loading');
                setTtsTestMsg('');
                
                try {
                    if (config.ttsProvider === 'browser') {
                        setTimeout(() => {
                            setTtsTestStatus('success');
                            setTtsTestMsg('浏览器语音引擎正常。');
                            speakWord("Test", 'en');
                        }, 500);
                        return;
                    }

                    if (config.ttsProvider === 'azure_tts') {
                        const defaultVoice = AZURE_VOICE_MAP[currentLang] || 'en-US-AvaMultilingualNeural';
                        const voiceName = config.ttsVoice || defaultVoice;
                        
                        const ssml = `<speak version='1.0' xml:lang='${LANG_CONFIG[currentLang].code}'><voice xml:lang='${LANG_CONFIG[currentLang].code}' name='${voiceName}'>Test</voice></speak>`;
                        
                        const response = await fetch(config.ttsUrl, {
                            method: 'POST',
                            headers: {
                                'Ocp-Apim-Subscription-Key': config.ttsKey,
                                'Content-Type': 'application/ssml+xml',
                                'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3',
                                'User-Agent': 'LingQPro'
                            },
                            body: ssml
                        });
                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`Azure Error: ${response.status}`);
                        }
                        setTtsTestStatus('success');
                        setTtsTestMsg(`连接成功！(${LANG_CONFIG[currentLang].label})`);
                        const blob = await response.blob();
                        new Audio(URL.createObjectURL(blob)).play();
                        return;
                    }

                    const response = await fetch(`${config.ttsUrl}/audio/speech`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.ttsKey}` },
                        body: JSON.stringify({ model: config.ttsModel, input: "Test", voice: config.ttsVoice || 'alloy' })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    setTtsTestStatus('success');
                    setTtsTestMsg('连接成功！');
                    const blob = await response.blob();
                    new Audio(URL.createObjectURL(blob)).play();

                } catch (e) {
                    setTtsTestStatus('error');
                    setTtsTestMsg('连接失败: ' + e.message);
                }
            };
            
            // 恢复默认配置
            const resetConfig = () => {
                if(confirm('确定要恢复默认配置吗？这会清除当前的 API Key。')) {
                    setConfig(DEFAULT_CONFIG);
                    setTransTestStatus('idle');
                    setTtsTestStatus('idle');
                }
            };

            // 获取 Azure Region Code
            const getAzureRegion = () => {
                const match = config.ttsUrl.match(/https:\/\/(.*?)\.tts\.speech/);
                return match ? match[1] : 'eastus';
            };

            // 设置 Azure Region
            const setAzureRegion = (region) => {
                const newUrl = `https://${region}.tts.speech.microsoft.com/cognitiveservices/v1`;
                setConfig(prev => ({ ...prev, ttsUrl: newUrl }));
            };

            return (
                <div className="flex flex-col h-full w-full bg-gray-50">
                    
                    {/* 顶部极简导航 */}
                    <header className="bg-white shadow-sm px-4 h-14 flex justify-between items-center z-10 shrink-0 border-b border-gray-100">
                        <div className="flex items-center gap-2 overflow-hidden">
                            <div className="bg-blue-600 text-white p-1 rounded">
                                <BookOpen size={18} />
                            </div>
                            <span className="font-bold text-gray-800 tracking-tight text-sm sm:text-base">LingQ Pro</span>
                            {fileName && <span className="text-xs text-gray-400 truncate max-w-[80px] sm:max-w-[150px] border-l border-gray-200 pl-2 ml-1">{fileName}</span>}
                        </div>

                        <div className="flex items-center gap-3">
                            <select 
                                value={currentLang} 
                                onChange={(e) => setCurrentLang(e.target.value)}
                                className="bg-transparent text-sm font-medium text-gray-600 outline-none"
                            >
                                {Object.entries(LANG_CONFIG).map(([key, conf]) => (
                                    <option key={key} value={key}>{conf.label}</option>
                                ))}
                            </select>
                            
                            <button onClick={() => setShowGenerateModal(true)} className="text-purple-600 hover:bg-purple-50 p-1.5 rounded-full transition" title="AI 生成">
                                <Sparkles size={18} />
                            </button>

                            {parsedWords.length > 0 ? (
                                <button onClick={() => {if(confirm("清空当前文章？")) {setParsedWords([]); setFileName("");}}} className="text-gray-400 hover:text-red-500 p-1.5 rounded-full transition">
                                    <Trash2 size={18} />
                                </button>
                            ) : (
                                <label className="cursor-pointer text-blue-600 hover:bg-blue-50 p-1.5 rounded-full transition">
                                    <Upload size={18} />
                                    <input type="file" accept=".txt,.docx" onChange={handleFileSelect} className="hidden" ref={fileInputRef} />
                                </label>
                            )}

                            <button onClick={() => {
                                setShowSettings(true);
                                setTransTestStatus('idle');
                                setTransTestMsg('');
                                setTtsTestStatus('idle');
                                setTtsTestMsg('');
                            }} className="text-gray-600 hover:bg-gray-100 p-1.5 rounded-full transition">
                                <SettingsIcon size={18} />
                            </button>
                        </div>
                    </header>

                    {/* 中间阅读区 */}
                    <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-10 bg-white sm:bg-gray-50 scroll-smooth pb-32">
                        {isGenerating && (
                            <div className="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mb-3"></div>
                                <p className="text-purple-800 text-sm font-medium animate-pulse">AI 正在撰写文章...</p>
                            </div>
                        )}

                        {parsedWords.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-4 opacity-60 mt-[-50px]">
                                <BookOpen size={48} className="text-gray-300" />
                                <div className="text-center space-y-1">
                                    <p className="text-sm">点击右上角导入文章</p>
                                    <p className="text-xs">或点击 ✨ 让 AI 生成</p>
                                </div>
                                <textarea 
                                    className="w-full max-w-md p-3 border border-gray-200 rounded-lg bg-gray-50 text-sm focus:bg-white focus:ring-1 focus:ring-blue-500 outline-none transition"
                                    rows="4"
                                    placeholder="或在此粘贴文本..."
                                    onBlur={(e) => {if(e.target.value.trim()) parseText(e.target.value, "Clipboard Content");}}
                                ></textarea>
                            </div>
                        ) : (
                            <div className="max-w-3xl mx-auto bg-white sm:shadow-sm sm:rounded-xl sm:p-8 min-h-[60vh] text-lg sm:text-xl leading-[2.2] text-gray-800 break-words font-serif sm:font-sans">
                                {parsedWords.map((token, idx) => (
                                    <span 
                                        key={idx}
                                        onClick={() => handleWordClick(token, idx)}
                                        className={`word-span ${selectedWord?.index === idx ? 'active' : ''}`}
                                    >
                                        {token}
                                    </span>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 底部查词面板 */}
                    {selectedWord && (
                        <div id="bottom-panel" className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)] p-4 pb-safe z-30 slide-up">
                            <div className="max-w-3xl mx-auto flex flex-col gap-2">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <h3 className="text-xl font-bold text-gray-900">{selectedWord.word}</h3>
                                        <button 
                                            onClick={() => speakWord(selectedWord.word)} 
                                            className="p-1.5 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition"
                                        >
                                            <Play size={16} fill="currentColor" />
                                        </button>
                                    </div>
                                    <button onClick={() => setSelectedWord(null)} className="text-gray-400 hover:text-gray-600 p-1">
                                        <X size={20} />
                                    </button>
                                </div>
                                
                                <div className="min-h-[2.5rem] text-base text-gray-700 leading-relaxed">
                                    {isTranslating ? (
                                        <div className="flex items-center gap-2 text-blue-500 text-sm py-1">
                                            <span className="animate-pulse">AI 正在思考释义...</span>
                                        </div>
                                    ) : (
                                        <div className="bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                                            {translation}
                                        </div>
                                    )}
                                </div>
                                <div className="text-xs text-gray-400 truncate border-t border-gray-50 pt-2 mt-1">
                                    上下文: {contextSentence}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 生成弹窗 */}
                    {showGenerateModal && (
                        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowGenerateModal(false)}>
                            <div className="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800">
                                    <Sparkles size={20} className="text-purple-500"/>
                                    生成 {LANG_CONFIG[currentLang].label} 阅读材料
                                </h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {['A1 (入门)', 'A2 (基础)', 'B1 (进阶)', 'B2 (中级)', 'C1 (高级)', 'C2 (精通)'].map(level => (
                                        <button
                                            key={level}
                                            onClick={() => generateArticle(level.split(' ')[0])}
                                            className="p-3 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 hover:text-purple-700 transition text-sm font-medium"
                                        >
                                            {level}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 设置弹窗 */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowSettings(false)}>
                            <div className="bg-white rounded-xl w-full max-w-md p-0 shadow-2xl flex flex-col max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50">
                                    <h2 className="font-bold text-gray-800 flex items-center gap-2">API 设置</h2>
                                    <button onClick={() => setShowSettings(false)} className="text-gray-400 hover:text-gray-600"><X size={20}/></button>
                                </div>

                                <div className="p-5 overflow-y-auto space-y-6">
                                    {/* 翻译设置 */}
                                    <section className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-gray-500 uppercase tracking-wider block">翻译 & 生成 (LLM)</label>
                                            <div className="text-xs font-medium">
                                                {transTestStatus === 'loading' && <span className="text-blue-500 flex items-center gap-1"><Loader size={12}/> 测试中...</span>}
                                                {transTestStatus === 'success' && <span className="text-green-600 flex items-center gap-1"><Check size={12}/> 成功</span>}
                                                {transTestStatus === 'error' && <span className="text-red-500 flex items-center gap-1"><AlertCircle size={12}/> 失败</span>}
                                            </div>
                                        </div>
                                        
                                        <div className="relative">
                                            <select 
                                                value={config.transProvider}
                                                onChange={(e) => {
                                                    const pid = e.target.value;
                                                    const preset = TRANS_PRESETS.find(p => p.id === pid);
                                                    if(preset) setConfig(prev => ({...prev, transProvider: pid, transUrl: preset.url, transModel: preset.model || prev.transModel}));
                                                }}
                                                className="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 appearance-none text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                {TRANS_PRESETS.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                            </select>
                                            <ChevronDown className="absolute right-3 top-3 text-gray-400 pointer-events-none" size={16} />
                                        </div>
                                        
                                        <input 
                                            type="text" 
                                            value={config.transUrl} 
                                            onChange={(e) => setConfig({...config, transUrl: e.target.value})}
                                            disabled={config.transProvider !== 'custom'}
                                            placeholder="API Address"
                                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-gray-50 text-gray-600"
                                        />
                                        <input 
                                            type="password" 
                                            value={config.transKey} 
                                            onChange={(e) => setConfig({...config, transKey: e.target.value})}
                                            placeholder="API Key (sk-...)"
                                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                        
                                        <div className="flex justify-between items-center pt-1">
                                            <span className="text-xs text-red-500">{transTestStatus === 'error' && transTestMsg}</span>
                                            <button 
                                                onClick={testTransConnection}
                                                disabled={transTestStatus === 'loading'}
                                                className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md transition"
                                            >
                                                测试连接
                                            </button>
                                        </div>
                                    </section>

                                    <hr className="border-gray-100"/>

                                    {/* 朗读设置 */}
                                    <section className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-gray-500 uppercase tracking-wider block">语音朗读 (TTS)</label>
                                            <div className="text-xs font-medium">
                                                {ttsTestStatus === 'loading' && <span className="text-blue-500 flex items-center gap-1"><Loader size={12}/> 测试中...</span>}
                                                {ttsTestStatus === 'success' && <span className="text-green-600 flex items-center gap-1"><Check size={12}/> 成功</span>}
                                                {ttsTestStatus === 'error' && <span className="text-red-500 flex items-center gap-1"><AlertCircle size={12}/> 失败</span>}
                                            </div>
                                        </div>

                                        <div className="relative">
                                            <select 
                                                value={config.ttsProvider}
                                                onChange={(e) => {
                                                    const pid = e.target.value;
                                                    const preset = TTS_PRESETS.find(p => p.id === pid);
                                                    if(preset) setConfig(prev => ({...prev, ttsProvider: pid, ttsUrl: preset.url}));
                                                }}
                                                className="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 appearance-none text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                {TTS_PRESETS.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                            </select>
                                            <ChevronDown className="absolute right-3 top-3 text-gray-400 pointer-events-none" size={16} />
                                        </div>

                                        {config.ttsProvider !== 'browser' && (
                                            <div className="space-y-3 animate-slide-up">
                                                {config.ttsProvider === 'azure_tts' ? (
                                                     <div className="space-y-3">
                                                         <div className="text-xs text-blue-600 bg-blue-50 p-2 rounded">
                                                            <strong>自动选择:</strong> {config.ttsVoice || (AZURE_VOICE_MAP[currentLang] || 'en-US-AvaMultilingualNeural')}
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-semibold text-gray-500 mb-1 block">Azure Region (区域代码)</label>
                                                            <input 
                                                                type="text" 
                                                                value={getAzureRegion()} 
                                                                onChange={(e) => setAzureRegion(e.target.value)}
                                                                placeholder="e.g. eastus, eastasia"
                                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                            />
                                                        </div>
                                                     </div>
                                                ) : (
                                                    <input 
                                                        type="text" 
                                                        value={config.ttsUrl} 
                                                        onChange={(e) => setConfig({...config, ttsUrl: e.target.value})}
                                                        placeholder="TTS Endpoint URL"
                                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-gray-50 text-gray-600"
                                                    />
                                                )}
                                                
                                                <input 
                                                    type="password" 
                                                    value={config.ttsKey} 
                                                    onChange={(e) => setConfig({...config, ttsKey: e.target.value})}
                                                    placeholder={config.ttsProvider === 'azure_tts' ? "Azure Subscription Key" : "OpenAI API Key"}
                                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                />
                                                
                                                {config.ttsProvider !== 'azure_tts' && (
                                                     <input 
                                                        type="text" 
                                                        value={config.ttsVoice} 
                                                        onChange={(e) => setConfig({...config, ttsVoice: e.target.value})}
                                                        placeholder="Voice (e.g., alloy)"
                                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                                                    />
                                                )}
                                            </div>
                                        )}
                                        
                                        <div className="flex justify-between items-center pt-1">
                                            <span className="text-xs text-red-500 max-w-[70%] truncate">{ttsTestStatus === 'error' && ttsTestMsg}</span>
                                            <button 
                                                onClick={testTTSConnection}
                                                disabled={ttsTestStatus === 'loading'}
                                                className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md transition"
                                            >
                                                测试发音
                                            </button>
                                        </div>
                                    </section>
                                </div>

                                <div className="p-4 border-t border-gray-100 bg-gray-50 flex gap-3">
                                    <button 
                                        onClick={resetConfig}
                                        className="flex-1 bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-50 transition flex items-center justify-center gap-2"
                                    >
                                        <RotateCcw size={16}/> 恢复默认
                                    </button>
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="flex-[2] bg-gray-900 text-white py-3 rounded-lg font-medium hover:bg-black transition shadow-lg"
                                    >
                                        保存配置
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
